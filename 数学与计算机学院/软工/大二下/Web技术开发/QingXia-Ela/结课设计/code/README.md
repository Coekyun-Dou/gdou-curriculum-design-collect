# web 课程设计

环境要求：`node v18.18.1 pnpm v8.6.12`

## 注意事项

想评语好看点就把报告字数写到4k字以上，老师不看你的报告内容，基本都是看字数的

## 碎碎念

web 课程设计说实话是我个人认为最麻烦的一个课，主要还是体现在实验上面，最麻烦的就是原创主题。

虽然最终就是要看你有没有掌握这个技术，但是个人认为UI设计不属于这个范畴里头。

建议是实验可以做到复刻某个界面，而不是自己想主题；不过这样就没法保证代码原创性，也很难查重。

建议速度让鼠鼠我去当助教来帮sensei查重代码😋。

涉及到权限验证和页面拦截的操作基本都是要 SSR 了，就算不需要的话也得用类似 express 这样的 web 框架，并设置静态文件访问权限。

SSR 来说相对方便，因为他与权限系统的集成度更高。

每年主题都不一样，所以本课设代码直接抄的意义不是很大，建议是阅读本 README 理清思路然后自己实现一遍。今年(2024)是航天网站主题，去年则是工匠精神。

## 环境变量

在你的项目目录下新建 `.env` 文件，这里是用来存储链接数据库凭据的信息：

```toml
DB_HOST=ip
DB_USER=usesname
DB_PASSWORD=
DB_DATABASE=
```

当然你也可以用 DBTest 类来替代默认导出的 DB，这样你连数据库都不需要了。

## 启动

数据库用的是 MySQL，执行本目录下的 `createDB.sql` 创建表

.env 文件可以配置连接数据库的信息

根目录下执行

```bash
$ pnpm i
$ pnpm dev
```

即可启动

## 注册、登录验证思路

### 注册

注册应该是最难的，因为其中还多了个验证码

本项目的思路是在每次访问注册页面时向服务器请求一个随机的验证码ID，这个ID可以映射到数据库里头的一个验证码：

```json
{
  "idcaptcha": "114",
  "image": "data/image:base64,png;514"
}
```

图片采用base64存储，这样就避免了还要专门生成一个验证码的服务器链接，还能直接用text存在数据库里头。

用户发送注册请求的请求体如下：

```json
{
  "username": "foo",
  "password": "bar",
  "idcaptcha": "114",
  "code": "514"
}
```

这时服务端就会根据 `idcaptcha` 的值，从而知道用户首次进入页面时请求的验证码是什么，并且可以跟数据库进行值对比。

对比通过后就可以写入用户的信息了，并在服务端调用登录方法获取一个有效的 cookie 返回给用户

#### 题外话：真实世界

真实世界不可能直接把 `idcaptcha` 返回给用户，本项目同理，我在申请验证码 ID 的地方添加了一个二级ID，这个ID会与数据库内的验证码进行映射，目的就是为了隐藏验证码真实数据库 ID。假如我直接将数据库验证码 ID 暴露出去，那么脚本小子甚至可以基于这个做一个验证码库，此时你的验证码就是形同虚设了。

真实世界中注册一般要求使用QQ邮箱或者手机号，因为这玩意真能保证唯一性吧，而且还能发邮件和短信进行验证。

真正的生产环境项目不会开一个表来预设验证码，一般是专门有一套流程直接生成验证码使用，这部分应该是由算法佬和内核佬实现，因为用数据库的优点是效率高，直接查，占用硬盘空间存储；而生成验证码肯定时间花的要多一些，但是优点就是有足够随机性质，且仅占用内存。为了安全性我们宁可选择随机生成验证码。

#### 思考：验证码超时

在项目中有一个验证码超时机制，即过了一分钟后该验证码记录会被删除，这样做会导致用户在页面思考了超过一分钟后终于输入验证码时却发现验证码不正确的问题，这有没有什么解决办法呢？

欢迎发起PR来修复这个bug！

### 登录验证

这个比较好说，实现方式有很多：

本项目就直接使用 cookie + session 了，cookie 是一个 uuid4 字符串，当用户提交自己的账号密码时，假如连接数据库查到了，就在响应体里面返回 cookie 信息，并由浏览器 `document.cookie` 来设置

每次请求页面时会走一遍 Astro 的中间件，中间件会根据请求头的 cookie 信息来查找用户是否登录了，然后把这些信息注入到中间件上下文，这时你在 astro 页面内就可以直接查询目前访问这个页面的用户是否登录，并根据状态重定向或者正常返回内容

